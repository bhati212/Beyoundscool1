
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beyondscool — Notes</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="brand">Beyondscool</div>
      <div class="spacer"></div>
      <nav class="nav">
        <a class="link active" href="/notes/">Notes</a>
        <a class="link" href="/quizzes/">Quizzes</a>
      </nav>
      <button class="btn secondary" id="openPrefs">Preferences</button>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <div class="card-head">
        <h1>Notes Library</h1>
        <div class="hint">Filtered by your Board / Grade / Language</div>
      </div>
      <div id="cards" class="grid-cards"></div>
    </section>
    <section class="card">
      <div class="card-head"><h2 id="viewerTitle">Open a note…</h2></div>
      <div class="viewer">
        <div class="overlay-top" title="Read-only view"></div>
        <iframe id="viewerFrame" loading="lazy" referrerpolicy="no-referrer"></iframe>
        <div class="watermark">Beyondscool • Read-only</div>
      </div>
      <p class="tiny">True blocking of downloads isn't possible on the web. This hides the default toolbar and adds a watermark.</p>
    </section>
  </main>

  <!-- Preferences Modal -->
  <dialog id="prefs" class="modal">
    <form method="dialog" class="panel" id="prefsForm">
      <div class="panel-head"><h3>Your Preferences</h3><button class="btn ghost" value="cancel" formmethod="dialog">Close</button></div>
      <div class="grid-2">
        <label class="field"><span>Board</span><select id="prefBoard"><option>CBSE</option><option>ICSE</option></select></label>
        <label class="field"><span>Grade</span><select id="prefGrade"><option>6</option><option>7</option><option>8</option><option selected>10</option><option>11</option><option>12</option></select></label>
        <label class="field"><span>Language</span><select id="prefLanguage"><option selected>English</option><option>Hindi</option></select></label>
        <label class="field"><span>Subjects (Ctrl/Cmd to multi-select)</span><select id="prefSubjects" multiple><option selected>Maths</option><option>Science</option><option>English</option></select></label>
      </div>
      <div class="field"><span>Interests</span><div class="badges">
        <label><input type="checkbox" value="PYQ" class="chip"> PYQ</label>
        <label><input type="checkbox" value="Speed Drills" class="chip"> Speed Drills</label>
        <label><input type="checkbox" value="Tricky" class="chip"> Tricky</label>
        <label><input type="checkbox" value="Formula Heavy" class="chip"> Formula Heavy</label></div>
      </div>
      <div class="actions"><button class="btn" id="savePrefs">Save</button></div>
    </form>
  </dialog>

  <script type="module">
    import { $, $$, DEFAULT_PREFS, openPrefsDialog, hydratePrefsForm, savePrefsFromForm, getPrefs } from '../assets/js/prefs.js';

    async function loadNotes(){
      const res = await fetch('../data/notes.json', { cache:'no-store' }).catch(()=>null);
      if(res && res.ok) return res.json();
      const res2 = await fetch('../data/notes.sample.json', { cache:'no-store' });
      return res2.json();
    }

    function tagBadge(t){ return `<span class="badge">${t}</span>`; }
    function cardHTML(n){
      const tags=(n.tags||[]).map(tagBadge).join('');
      const practice = n.practice_link? `<a class="btn small" target="_blank" href="${n.practice_link}">Practice 3 MCQs</a>`:'';
      const openBtn = n.file_url? `<button class="btn small" data-open="${encodeURIComponent(n.file_url)}" data-title="${encodeURIComponent(n.title)}">Open</button>`:'';
      return `<div class="card-note">
        <div class="note-title">${n.title}</div>
        <div class="note-desc">${n.description||""}</div>
        <div class="badges">${tags}</div>
        <div class="actions">${openBtn}${practice}</div>
      </div>`;
    }

    function filterByPrefs(data, p){
      return data.filter(n=>{
        const okB=!p.board||n.board===p.board;
        const okG=!p.grade||String(n.grade)===String(p.grade);
        const okL=!p.language||(n.language||"English")===p.language;
        return okB && okG && okL;
      });
    }

    async function init(){
      const data = await loadNotes();
      const prefs = { ...DEFAULT_PREFS, ...getPrefs() };
      const list = filterByPrefs(data, prefs);
      const container = $("#cards");
      container.innerHTML = list.map(cardHTML).join("");
      container.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-open]"); if(!btn) return;
        const url = decodeURIComponent(btn.dataset.open);
        const title = decodeURIComponent(btn.dataset.title);
        $("#viewerFrame").src = url; $("#viewerTitle").textContent = title;
        document.querySelector(".viewer")?.scrollIntoView({ behavior:"smooth" });
      }, { once:true });
    }

    document.getElementById("openPrefs")?.addEventListener("click", openPrefsDialog);
    document.getElementById("savePrefs")?.addEventListener("click", savePrefsFromForm);
    init();
  </script>
</body>
</html>
